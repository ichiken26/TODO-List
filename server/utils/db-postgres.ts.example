/**
 * PostgreSQLデータベース接続の例
 * SQLiteからPostgreSQLへの移行時に使用
 * 
 * 使用方法:
 * 1. npm install pg @types/pg
 * 2. このファイルを db.ts にリネーム
 * 3. DATABASE_URL環境変数を設定
 */

import { Pool } from 'pg';
import { DEFAULT_PRIORITY } from '~/constants/priority';

/**
 * PostgreSQL接続プール
 */
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

/**
 * データベース接続を取得
 */
export function getDatabase(): Pool {
  return pool;
}

/**
 * データベースの初期化（テーブル作成）
 */
export async function initializeDatabase(): Promise<void> {
  const client = await pool.connect();
  
  try {
    await client.query('BEGIN');

    // usersテーブル
    await client.query(`
      CREATE TABLE IF NOT EXISTS users (
        id TEXT PRIMARY KEY,
        user_name TEXT NOT NULL UNIQUE,
        password TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);

    // 既存のテーブルにカラムが存在しない場合は追加（マイグレーション）
    const userColumns = await client.query(`
      SELECT column_name 
      FROM information_schema.columns 
      WHERE table_name = 'users'
    `);
    const columnNames = userColumns.rows.map(row => row.column_name);

    if (!columnNames.includes('user_name')) {
      await client.query(`ALTER TABLE users ADD COLUMN user_name TEXT`);
    }
    if (!columnNames.includes('password')) {
      await client.query(`ALTER TABLE users ADD COLUMN password TEXT`);
    }

    // UNIQUE制約の追加（既に存在する場合はエラーを無視）
    try {
      await client.query(`CREATE UNIQUE INDEX IF NOT EXISTS idx_users_user_name ON users(user_name)`);
    } catch (error: any) {
      if (!error.message.includes('already exists')) {
        throw error;
      }
    }

    // todosテーブル
    await client.query(`
      CREATE TABLE IF NOT EXISTS todos (
        id TEXT PRIMARY KEY,
        partition_key TEXT NOT NULL,
        priority INTEGER NOT NULL DEFAULT ${DEFAULT_PRIORITY},
        todo TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (partition_key) REFERENCES users(id)
      )
    `);

    // インデックスの作成
    await client.query(`
      CREATE INDEX IF NOT EXISTS idx_todos_partition_key ON todos(partition_key)
    `);

    await client.query('COMMIT');
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}

/**
 * データベース接続を閉じる
 */
export async function closeDatabase(): Promise<void> {
  await pool.end();
}

// アプリ起動時に初期化
if (process.env.NODE_ENV !== 'test') {
  initializeDatabase().catch(console.error);
}

